
name: Update Silver Spot Price

on:
  schedule:
    - cron: "0 * * * *"   # EVERY HOUR
  workflow_dispatch:      # ALLOW MANUAL RUN

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch spot price
        env:
          METALS_API_KEY: ${{ secrets.METALS_API_KEY }}
        run: |
          mkdir -p assets/data

          # EXAMPLE: METALS.DEV SPOT ENDPOINT (ADJUST IF YOU USE A DIFFERENT PROVIDER)_
          curl -s "https://api.metals.dev/v1/metal/spot?api_key=${METALS_API_KEY}&metal=silver&currency=USD" \
            -o assets/data/spot_raw.json

          # KEEP A NORMALIZED JSON FILE YOUR FRONTEND CAN EASILY READ.
          # NOTE: YOU MAY NEED TO ADJUST THE JQ PATH ONCE WE SEE THE EXACT RESPONSE SHAPE.
          sudo apt-get update && sudo apt-get install -y jq

          PRICE=$(jq -r '.rate.price // .price // .spot // .data.price // empty' assets/data/spot_raw.json)

          if [ -z "$PRICE" ]; then
            echo "Could not parse price from response:"
            cat assets/data/spot_raw.json
            exit 1
          fi

          jq -n --arg price "$PRICE" --arg updated "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
            '{ metal:"silver", currency:"USD", price" ($price|tonumber), updated_utc:$updated }' \
            > assets/data/spot.json

      - name: Commit and push if changed
        run: |
          git config user.name "silver-stack-bot"
          git config user.email "action@users.noreply.github.com"
          git add assets/data/spot.json assets/data/spot_raw.json
          git diff --cached --quiet || (git commit -m "Updated silver spot price" && git push)

